<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of spk_AnalogIsSaturated</title>
  <meta name="keywords" content="spk_AnalogIsSaturated">
  <meta name="description" content="detects trials exceeding a range of analog values">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2003 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../index.html">Home</a> &gt;  <a href="index.html">@al_spk</a> &gt; spk_AnalogIsSaturated.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../index.html"><img alt="<" border="0" src="../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for @al_spk&nbsp;<img alt=">" border="0" src="../right.png"></a></td></tr></table>-->

<h1>spk_AnalogIsSaturated
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>detects trials exceeding a range of analog values</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>function [SatTrials,isSat] = spk_AnalogIsSaturated(s,DataThresh,SatBinNum,Ev1,Ev2,DoPlot) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre class="comment"> detects trials exceeding a range of analog values
 [s,SatTrials,isSat] = spk_AnalogIsSaturated(s,DataThresh,Ev1,Ev2,AllowPeaksFlag,DoPlot)
 INPUT
 DataThresh ... [lower boundary , upper boundary]
 SatBinNum .... number of consecutive bins consisting with criterion
 Ev1,Ev2 ...... Event Window
 DoPlot ....... plot detected analog data, one channel per figure
 OUTPUT
 SatTrials .... logical, index of saturated trials 
 isSat ........ logical, index of saturated bins</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="spk_AnalogEventWindow.html" class="code" title="function [b,t,tVec] = spk_AnalogEventWindow(s,Ev,EvOffset)">spk_AnalogEventWindow</a>	returns start and end bins of a window defined by an event(s)</li><li><a href="spk_AnalogTimeVec.html" class="code" title="function t = spk_AnalogTimeVec(s,Chan)">spk_AnalogTimeVec</a>	retrieves times of analog data bins</li></ul>
This function is called by:
<ul style="list-style-image:url(../matlabicon.gif)">
</ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="#_sub1" class="code">function i = IsSaturated(M,SatBinNum)</a></li><li><a href="#_sub2" class="code">function i = IsClipped(M,ClipVal,AllowPeaksFlag)</a></li></ul>
<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function [SatTrials,isSat] = spk_AnalogIsSaturated(s,DataThresh,SatBinNum,Ev1,Ev2,DoPlot)</a>
0002 
0003 <span class="comment">% detects trials exceeding a range of analog values</span>
0004 <span class="comment">% [s,SatTrials,isSat] = spk_AnalogIsSaturated(s,DataThresh,Ev1,Ev2,AllowPeaksFlag,DoPlot)</span>
0005 <span class="comment">% INPUT</span>
0006 <span class="comment">% DataThresh ... [lower boundary , upper boundary]</span>
0007 <span class="comment">% SatBinNum .... number of consecutive bins consisting with criterion</span>
0008 <span class="comment">% Ev1,Ev2 ...... Event Window</span>
0009 <span class="comment">% DoPlot ....... plot detected analog data, one channel per figure</span>
0010 <span class="comment">% OUTPUT</span>
0011 <span class="comment">% SatTrials .... logical, index of saturated trials</span>
0012 <span class="comment">% isSat ........ logical, index of saturated bins</span>
0013 
0014 <span class="keyword">if</span> nargin&lt;3
0015     Ev1=<span class="string">''</span>;Ev2=<span class="string">''</span>;DoPlot=true;AllowPeaksFlag=false;
0016 <span class="keyword">end</span>
0017 SatTrials = false(0,0);
0018 
0019 <span class="comment">%% check analog channels</span>
0020 nCh = length(s.currentanalog);
0021 
0022 <span class="comment">%% loop channels</span>
0023 <span class="keyword">for</span> iCh = 1:nCh
0024     ChNr = s.currentanalog(iCh);
0025     [nT,nB] = size(s.analog{ChNr});
0026     
0027     <span class="comment">%% check maximum value</span>
0028     MaxVal = max(s.analog{ChNr}(:));
0029     MinVal = min(s.analog{ChNr}(:));
0030     disp([<span class="string">'Check for saturated bins in channel Ch. '</span> num2str(ChNr) <span class="string">' max: '</span> num2str(MaxVal) <span class="string">' min: '</span> num2str(MinVal)]);
0031 
0032     <span class="comment">%% detect saturated</span>
0033     <span class="keyword">if</span> isempty(DataThresh)
0034         iMin = <a href="#_sub1" class="code" title="subfunction i = IsSaturated(M,SatBinNum)">IsSaturated</a>(s.analog{ChNr}'.*(-1),SatBinNum);
0035         iMax = <a href="#_sub1" class="code" title="subfunction i = IsSaturated(M,SatBinNum)">IsSaturated</a>(s.analog{ChNr}',SatBinNum);
0036     <span class="keyword">elseif</span> length(DataThresh) == 2
0037         iMin = <a href="#_sub2" class="code" title="subfunction i = IsClipped(M,ClipVal,AllowPeaksFlag)">IsClipped</a>(s.analog{ChNr}'.*(-1),DataThresh(1).*(-1),SatBinNum);
0038         iMax = <a href="#_sub2" class="code" title="subfunction i = IsClipped(M,ClipVal,AllowPeaksFlag)">IsClipped</a>(s.analog{ChNr}',DataThresh(2),SatBinNum);
0039     <span class="keyword">end</span>
0040     isSat{iCh} = iMin'|iMax';
0041     
0042     <span class="comment">%% set bins outside time window back to zeros</span>
0043     <span class="keyword">if</span> ~isempty(Ev1) &amp;&amp; ~isempty(Ev2) &amp;&amp; any(isSat{iCh}(:))
0044         
0045         <span class="keyword">if</span> ~iscell(Ev1)&amp;&amp;~iscell(Ev2)
0046             Ev1 = {Ev1};Ev2 = {Ev2};
0047         <span class="keyword">end</span>
0048         
0049         isWinSat = false(size(isSat{iCh}));
0050         <span class="keyword">for</span> iWin = 1:length(Ev1)
0051             [bWin,tWin,t] = <a href="spk_AnalogEventWindow.html" class="code" title="function [b,t,tVec] = spk_AnalogEventWindow(s,Ev,EvOffset)">spk_AnalogEventWindow</a>(s,Ev1{iWin},Ev2{iWin});
0052             isWin = false(1,nB);
0053             <span class="keyword">for</span> iTr = 1:nT
0054                 isWinSat(iTr,bWin(iTr,1):bWin(iTr,2)) = isSat{iCh}(iTr,bWin(iTr,1):bWin(iTr,2));
0055             <span class="keyword">end</span>
0056         <span class="keyword">end</span>
0057         isSat{iCh} = isWinSat;
0058     <span class="keyword">end</span>
0059     
0060     <span class="comment">%% check for any saturations in this trial</span>
0061     SatTrials(:,iCh) = any(isSat{iCh},2);
0062     
0063     <span class="comment">%% plot this channel</span>
0064     <span class="keyword">if</span> DoPlot &amp;&amp; any(isSat{iCh}(:)) 
0065         n = sum(SatTrials(:,iCh));
0066         t = <a href="spk_AnalogTimeVec.html" class="code" title="function t = spk_AnalogTimeVec(s,Chan)">spk_AnalogTimeVec</a>(s,ChNr);
0067         figure
0068         line(repmat(t',[1 n]),[s.analog{ChNr}(SatTrials(:,iCh),:)+repmat([0:n-1]',[1 nB])*DataThresh(2)]',<span class="string">'color'</span>,<span class="string">'b'</span>);
0069     <span class="keyword">end</span>
0070     
0071 <span class="keyword">end</span>
0072 
0073 <a name="_sub1" href="#_subfunctions" class="code">function i = IsSaturated(M,SatBinNum)</a>
0074 [nBins,nRuns] = size(M);
0075 mx = max(M(:));<span class="comment">% assumes common maximum for whole data matrix</span>
0076 i = M&gt;=mx;
0077 <span class="keyword">for</span> iB = 1:nBins-(SatBinNum-1)
0078     i(iB,~all(   i(iB:iB+(SatBinNum-1),:)   ,1)) = false;
0079 <span class="keyword">end</span>
0080 
0081 <a name="_sub2" href="#_subfunctions" class="code">function i = IsClipped(M,ClipVal,AllowPeaksFlag)</a>
0082 
0083 <span class="comment">% returns index of saturated values</span>
0084 <span class="comment">% data series in columns</span>
0085 
0086 dims = size(M);
0087 i = false(size(M));
0088 i = M&gt;=ClipVal;
0089 
0090 <span class="keyword">if</span> AllowPeaksFlag
0091     di = diff(i,[],1);
0092     PeakIndex = (cat(1,zeros(1,dims(2)),di)&gt;0 &amp; cat(1,di,zeros(1,dims(2)))&lt;0);
0093     i(PeakIndex) = false;
0094 <span class="keyword">end</span>
0095</pre></div>
<hr><address>Generated on Thu 05-Nov-2009 11:31:16 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/">m2html</a></strong> &copy; 2003</address>
</body>
</html>